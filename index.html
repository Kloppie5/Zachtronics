<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script>
      exapunks_files = [
        "EXAPUNKS/solutions/trash-world-news-1.solution"
      ]

      function deserialize_exapunks_solution ( solution_file_path, debug = false ) {
        $.ajax({
          url: solution_file_path,
          accepts: {
            exapunkssolution: 'application/x-some-custom-type'
          },
          dataType: 'exapunkssolution',
          converters: {
            'text exapunkssolution': function(result) {
              var bytes = new Uint8Array(result.length)
              for ( var i = 0 ; i < result.length ; ++i ) {
                bytes[i] = result.charCodeAt(i)
              }
              if ( debug ) console.log(bytes)

              var cursor = 0
              var file_version = new Int32Array(bytes.buffer.slice(cursor, cursor + 4))[0]; cursor += 4
              if ( debug ) console.log("File Version: " + file_version)
              var file_id_string_length = new Int32Array(bytes.buffer.slice(cursor, cursor + 4))[0]; cursor += 4
              var file_id = String.fromCharCode.apply(null, new Uint8Array(bytes.buffer.slice(cursor, cursor + file_id_string_length))); cursor += file_id_string_length
              if ( debug ) console.log("File ID: " + file_id)
              var solution_name_string_length = new Int32Array(bytes.buffer.slice(cursor, cursor + 4))[0]; cursor += 4
              var solution_name = String.fromCharCode.apply(null, new Uint8Array(bytes.buffer.slice(cursor, cursor + solution_name_string_length))); cursor += solution_name_string_length
              if ( debug ) console.log("Solution Name: " + solution_name)
              cursor += 4 // Unknown 0
              cursor += 4 // Unknown 0
              cursor += 4 // Statistic Count = 3
              cursor += 4 // Statistic id 0
              var statistic_cycles = new Int32Array(bytes.buffer.slice(cursor, cursor + 4))[0]; cursor += 4
              if ( debug ) console.log("Statistic Cycles: " + statistic_cycles)
              cursor += 4 // Statistic id 1
              var statistic_size = new Int32Array(bytes.buffer.slice(cursor, cursor + 4))[0]; cursor += 4
              if ( debug ) console.log("Statistic Size: " + statistic_size)
              cursor += 4 // Statistic id 2
              var statistic_activity = new Int32Array(bytes.buffer.slice(cursor, cursor + 4))[0]; cursor += 4
              if ( debug ) console.log("Statistic Activity: " + statistic_activity)
              var exa_count = new Int32Array(bytes.buffer.slice(cursor, cursor + 4))[0]; cursor += 4
              if ( debug ) console.log("Exa Count: " + exa_count)
              var exas = {}
              for ( var i = 0 ; i < exa_count ; ++i ) {
                var leading_byte = bytes[cursor]; cursor += 1
                var exa_name_string_length = new Int32Array(bytes.buffer.slice(cursor, cursor + 4))[0]; cursor += 4
                var exa_name = String.fromCharCode.apply(null, new Uint8Array(bytes.buffer.slice(cursor, cursor + exa_name_string_length))); cursor += exa_name_string_length
                if ( debug ) console.log("Exa Name: " + exa_name)
                var exa_source_code_string_length = new Int32Array(bytes.buffer.slice(cursor, cursor + 4))[0]; cursor += 4
                var exa_source_code = String.fromCharCode.apply(null, new Uint8Array(bytes.buffer.slice(cursor, cursor + exa_source_code_string_length))); cursor += exa_source_code_string_length
                if ( debug ) console.log("Exa Source Code: " + exa_source_code)
                cursor += 102 // 102 flags
                exas[exa_name] = exa_source_code
              }

              return {
                file_version: file_version,
                file_id: file_id,
                solution_name: solution_name,
                statistic_cycles: statistic_cycles,
                statistic_size: statistic_size,
                statistic_activity: statistic_activity,
                exas: exas
              }
            }
          },
          success: function(result) {
            console.log("success")
            console.log(result);
          }
        })
        return ""
      }
      function dump_exapunks ( ) {
        for ( var i = 0; i < exapunks_files.length; i++ ) {
          var solution = deserialize_exapunks_solution( exapunks_files[i] )
          console.log( solution )
        }
      }
    </script>
  </head>
  <body>
    Hello again~
    <button onclick="dump_exapunks()">Dump EXAPUNKS</button>
  </body>
</html>
